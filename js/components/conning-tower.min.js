"use strict";function _classCallCheck(t,i){if(!(t instanceof i))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function t(t,i){for(var e=0;e<i.length;e++){var a=i[e];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(t,a.key,a)}}return function(i,e,a){return e&&t(i.prototype,e),a&&t(i,a),i}}(),ConningTower=function(){function t(i){var e=i.bigDataUtil,a=i.moduleType,s=i.cityClick,n=void 0===s?$.noop:s,o=i.searchResultItemClick,c=void 0===o?$.noop:o,l=i.locationCallback,r=void 0===l?$.noop:l;_classCallCheck(this,t),this.bigDataUtil=e,this.moduleType=a,this.apiUrl={search:"/api/common/acWord",businessCity:"/api/common/businessCity",getCityByLola:"/api/common/getCityByLatLon"},this.cityClick=n,this.searchResultItemClick=c,this.locationCallback=r,this.states={locationStage:0,locationMessage:null,locationFailCause:null,locationCityId:null,locationCityName:null,locationCityPinyin:null,locationCityChina:null},this.consts={visitedCityId:$("#visitedCityId").val(),visitedCityName:$("#visitedCityName").val(),visitedCityPinyin:$("#visitedCityPinyin").val(),visitedCityChina:$("#visitedCityChina").val(),$conningTowerCitySelectEntrance:$(".conning-tower dl dt"),$investment:$(".notopen-investment"),$investmentCitySwitch:$(".notopen-investment .change"),$hamburgMenu:$(".conning-tower .hamburg-menu"),$appDownload:$(".navigator-pop .app-download"),$navigatorMask:$(".navigator-mask"),$navigatorPop:$(".navigator-pop"),$conningTowerBack:$(".conning-tower .back"),$substituteMask:$(".substitute-mask"),$searchInputBox:$(".substitute-mask .search-substitute .input-section input"),$searchBack:$(".substitute-mask .search-substitute .back"),$clearKeywords:$(".substitute-mask .search-substitute .input-section .icon-close"),$clearHistory:$(".substitute-mask .list-container .clear-history"),$searchResultList:$(".substitute-mask .list-container .list"),$searchResultListAssistant:$(".substitute-mask .list-container div"),$searchForm:$(".substitute-mask .search-substitute form"),$citySelector:$(".city-selector")},this.detectSearchResultClick(),this.addEventListener(),this.location()}return _createClass(t,[{key:"addEventListener",value:function(){var t=this;this.consts.$conningTowerCitySelectEntrance.click(function(){t.popCitySelector()}),this.consts.$investmentCitySwitch.click(function(){t.consts.$investment.addClass("hidden").removeClass("visible"),t.popCitySelector()}),this.consts.$hamburgMenu.click(function(){$(document.body).css({"overflow-y":"hidden"}),t.consts.$navigatorMask.fadeIn(100),t.consts.$navigatorPop.animate({right:0},100)}),this.consts.$navigatorMask.click(function(){$(document.body).css({"overflow-y":"auto"}),t.consts.$navigatorMask.fadeOut(100),t.consts.$navigatorPop.animate({right:"-200px"},100)}),this.consts.$conningTowerBack.click(function(){history.back()}),$(".conning-tower dl dd").click(function(){t.consts.$substituteMask.show(50),t.consts.$searchInputBox.trigger("focus")}),this.consts.$searchBack.click(function(){t.consts.$substituteMask.hide(50)}),this.consts.$clearKeywords.click(function(){t.consts.$searchInputBox.val("").trigger("focus")}),this.consts.$clearHistory.click(function(){t.consts.$searchResultList.empty(),t.consts.$searchResultListAssistant.hide(100),delete window.localStorage[t.moduleType+"SearchHistory"]}),this.consts.$appDownload.click(function(){nativeSchema.loadSchema({schema:"external_call",protocal:"wkzf",loadWaiting:"1500",failUrl:"https://m.wkzf.com/download/transit?from=esfList",apkInfo:{PKG:"com.wukong.ua",CATEGORY:"android.intent.category.DEFAULT",ACTION:"android.intent.action.VIEW"}})}),this.consts.$searchInputBox.on("keyup focus",function(){var i=t.consts.$searchInputBox.val()?$.trim(t.consts.$searchInputBox.val()):"";if(!i||i!=t.consts.$searchInputBox.attr("data-last")){if(t.consts.$searchResultList.empty(),t.consts.$searchResultListAssistant.hide(100),!i){var e=window.localStorage[t.moduleType+"SearchHistory"];return e=e?JSON.parse(e):[],e&&t.renderSearchResult({items:e,history:!0}),void t.consts.$searchInputBox.attr("data-last",i)}var a={xf:"newhouselist",esf:"oldhouselist",rent:"renthouselist"};t.request({apiUrl:t.apiUrl.search,requestData:{key:i,pageName:a[t.moduleType],cityId:parseInt(t.consts.visitedCityId,10)},success:function(i){0===i.data.secondHouseTotal?$(".substitute-mask .list-container .list").empty().append('<li class="no-data"><dl><dt>未找到该地址，请重新搜索</dt><dd>您可以更换其他关键字再试一次</dd></dl></li>'):t.renderSearchResult({items:i.data.secondHouseList,history:!1})}}),t.consts.$searchInputBox.attr("data-last",i)}}),this.consts.$searchForm.submit(function(t){$(".substitute-mask .list-container .list li").eq(0).trigger("click"),t.preventDefault()})}},{key:"request",value:function(t){var i=t.apiUrl,e=t.requestData,a=t.success,s=void 0===a?$.noop:a;try{$.ajax({url:i,data:e,dataType:"json",error:function(t){$.tips("调用数据接口："+i+" 失败！请测试您的数据接口！",3)},success:function(t){"1"===t.status.toString()?s(t):$.tips(t.message,3)}})}catch(n){$.tips("错误名称："+n.name+"\n错误描述："+n.message,3)}}},{key:"citySelectorEventDelegate",value:function(){var t=this,i=$(".city-selector .caption .tabs-handle").is(":visible")?"72px":"28px";$(".city-selector .tabs-frame").css({"margin-top":i}),$(".city-selector .tabs-frame."+$(".city-selector .caption .tabs-handle li.on").eq(0).data("sign")).show();var e=$(".city-selector .caption .tabs-handle li");e.click(function(){e.removeClass("on"),$(this).addClass("on"),$(".city-selector .tabs-frame").hide(),$(".city-selector .tabs-frame."+$(this).data("sign")).show()}),$(".city-selector .tabs-frame a").click(function(i){var e=$(i.currentTarget);e.attr("data-cityid")&&($.cookie("selectedCityId",e.data("cityid"),{path:"/"}),$.cookie("selectedCityName",e.text(),{path:"/"}),$.cookie("selectedCityPinyin",e.data("pinyin"),{path:"/"}),$.cookie("selectedCityChina",e.data("china"),{path:"/"}),t.cityClick(),t.retractCitySelector(),e.data("cityid")!=t.consts.visitedCityId&&(window.location.href=t.combineUrl(e.data("pinyin"))))})}},{key:"filterBusinessCity",value:function(t){var i={esf:1,rent:2,xf:3},e=i[this.moduleType],a={domestic:{},overseas:{}};return t&&t.domesticCityList&&t.domesticCityList.forEach(function(t){var i=!1;if(t.businessList&&t.businessList.forEach(function(t){t.businessId===e&&(i=!0)}),i){var s=t.pinyin.charAt(0).toUpperCase();a.domestic.hasOwnProperty(s)||(a.domestic[s]=[]),a.domestic[s].push({cityId:t.cityId,cityName:t.cityName,pinyin:t.pinyin,cityType:t.cityType})}}),t&&t.overseaCityList&&t.overseaCityList.forEach(function(t){var i=!1;if(t.businessList&&t.businessList.forEach(function(t){t.businessId===e&&(i=!0)}),i){var s=t.pinyin.charAt(0).toUpperCase();a.overseas.hasOwnProperty(s)||(a.overseas[s]=[]),a.overseas[s].push({cityId:t.cityId,cityName:t.cityName,pinyin:t.pinyin,cityType:t.cityType})}}),a}},{key:"location",value:function(){var t=this;if($.cookie("visitedCityId")&&$.cookie("visitedCityId")!=this.consts.visitedCityId&&$.cookie("selectedCityId")&&$.cookie("selectedCityId")!=this.consts.visitedCityId)return alert("先前访问过H5城市，并且选择过城市，这两个城市值都不等于路由城市，所以跳转到先前访问城市"),void(window.location.href=this.combineUrl($.cookie("visitedCityPinyin")));if(this.setVisitedCityCache(),!navigator.geolocation)return void $.tips("您的浏览器不支持定位地理位置",3);this.states.locationStage=1,this.states.locationMessage="正在定位中...";var i={enableHighAccuracy:!1,maximumAge:0,timeout:1e4};navigator.geolocation.getCurrentPosition(function(i){var e=i.coords.latitude,a=i.coords.longitude;t.states.locationStage=2,$.cookie("locationLatitude",e,{path:"/",expires:525600}),$.cookie("locationLongitude",a,{path:"/",expires:525600}),t.locationCallback({latitude:e,longitude:a}),t.request({apiUrl:t.apiUrl.getCityByLola,requestData:{latitude:e,longitude:a},success:function(i){t.states.locationMessage=i.data.cityName,t.states.locationCityId=i.data.cityId,t.states.locationCityName=i.data.cityName,t.states.locationCityPinyin=i.data.cityPinyin,t.states.locationCityChina=i.data.china,$(".city-selector .tabs-frame .location-city").replaceWith('<a class="location-city" data-cityid="'+t.states.locationCityId+'" data-pinyin="'+t.states.locationCityPinyin+'" data-china="'+t.states.locationCityChina+'">'+t.states.locationCityName+"</a>"),$.cookie("selectedCityPinyin")||i.data.cityId==t.consts.visitedCityId||(alert("定位成功！没有用户选择的城市，而且定位城市不同于路由城市，将要直接跳转到定位城市！"),window.location.href=t.combineUrl(i.data.cityPinyin))}})},function(i){switch(t.states.locationStage=2,i.code){case i.PERMISSION_DENIED:t.states.locationMessage="定位服务暂未开启",t.states.locationFailCause="PERMISSION_DENIED",t.localtionFail(!1);break;case i.POSITION_UNAVAILABLE:t.states.locationMessage="定位失败",t.states.locationFailCause="POSITION_UNAVAILABLE",t.localtionFail(!0);break;case i.TIMEOUT:t.states.locationMessage="定位失败",t.states.locationFailCause="TIMEOUT",t.localtionFail(!0);break;case i.UNKNOWN_ERROR:t.states.locationMessage="定位失败",t.states.locationFailCause="UNKNOWN_ERROR",t.localtionFail(!0)}},i)}},{key:"retractCitySelector",value:function(){this.consts.$citySelector.hide(),$("body>.container").show()}},{key:"popCitySelector",value:function(){var t=this;this.consts.$citySelector.slideDown(200),$("body>.container").hide(),this.bigDataUtil.bigData({pageName:"1005",type:1}),$(".city-selector .tabs-frame").children().length||this.request({apiUrl:this.apiUrl.businessCity,requestData:{},success:function(i){var e=t.filterBusinessCity(i.data),a='<ul class="tabs-handle"><li class="on" data-sign="domestic">国内</li><li data-sign="overseas">国际</li></ul>';($.isEmptyObject(e.domestic)||$.isEmptyObject(e.overseas))&&(a=$.isEmptyObject(e.domestic)?'<ul class="tabs-handle" style="display : none"><li data-sign="domestic">国内</li><li class="on" data-sign="overseas">国际</li></ul>':'<ul class="tabs-handle" style="display : none"><li class="on" data-sign="domestic">国内</li><li data-sign="overseas">国际</li></ul>'),$(".city-selector .caption").append(a);var s=2==t.states.locationStage&&!t.states.locationFailCause&&t.states.locationCityName?'<a class="location-city" data-cityid="'+t.states.locationCityId+'" data-pinyin="'+t.states.locationCityPinyin+'" data-china="'+t.states.locationCityChina+'">'+t.states.locationCityName+"</a>":'<a class="location-city">'+t.states.locationMessage+"</a>",n=$(document.createElement("DIV")).addClass("tabs-frame domestic");if(n.append("<span>定位城市</span>"+s),!$.isEmptyObject(e.domestic))for(var o in e.domestic)n.append("<span>"+o+"</span>"),e.domestic[o].forEach(function(t){n.append('<a data-cityid="'+t.cityId+'" data-pinyin="'+t.pinyin+'" data-china="'+t.cityType+'">'+t.cityName+"</a>")});t.consts.$citySelector.append(n);var c=$(document.createElement("DIV")).addClass("tabs-frame overseas");if(c.append("<span>定位城市</span>"+s),!$.isEmptyObject(e.overseas))for(var l in e.overseas)c.append("<span>"+l+"</span>"),e.overseas[l].forEach(function(t){c.append('<a data-cityid="'+t.cityId+'" data-pinyin="'+t.pinyin+'" data-china="'+t.cityType+'">'+t.cityName+"</a>")});t.consts.$citySelector.append(c),t.citySelectorEventDelegate()}})}},{key:"localtionFail",value:function(t){var i=this;this.states.locationCityId=null,this.states.locationCityName=null,this.states.locationCityPinyin=null,this.states.locationCityChina=null,$.cookie("locationLatitude",null,{path:"/",expires:525600}),$.cookie("locationLongitude",null,{path:"/",expires:525600}),this.locationCallback(),$(".city-selector .tabs-frame .location-city").replaceWith('<a class="location-city">'+this.states.locationMessage+"</a>"),$.cookie("selectedCityPinyin")?$.cookie("selectedCityPinyin")!=this.consts.visitedCityPinyin&&(alert("定位失败！而且用户选择过跟当前不同的城市，将要跳转到用户选择的城市..."),window.location.href=this.combineUrl($.cookie("selectedCityPinyin"))):t?$.modal({id:"orientateTimeoutDialog",title:"",content:"定位失败<br>请手动选择您的城市",buttons:[{text:"去选择",className:"goto-select-city",clickCallback:function(){$.modal.close("orientateTimeoutDialog"),i.popCitySelector()}}]}):this.popCitySelector()}},{key:"setVisitedCityCache",value:function(){$.cookie("visitedCityId",this.consts.visitedCityId,{path:"/",expires:525600}),$.cookie("visitedCityName",this.consts.visitedCityName,{path:"/",expires:525600}),$.cookie("visitedCityPinyin",this.consts.visitedCityPinyin,{path:"/",expires:525600}),$.cookie("visitedCityChina",this.consts.visitedCityChina,{path:"/",expires:525600})}},{key:"combineUrl",value:function(t){var i=window.location.href.split("/");return i[3]=t,i=i.slice(0,5),i.join("/")}},{key:"renderSearchResult",value:function(t){var i=this,e=t.items,a=t.history,s=void 0!==a&&a;e&&e.forEach(function(t){var e=$(document.createElement("LI")),a=s?{xf:"1050010",esf:"1068013",rent:""}:{xf:"1050011",esf:"1068014",rent:""},n=s?{search_history:t.estateDesc}:{choice_content:t.estateDesc};a[i.moduleType]&&e.attr("data-bigdata",encodeURIComponent(JSON.stringify({eventName:a[i.moduleType],eventParam:n}))),e.attr("data-detail",encodeURIComponent(JSON.stringify(t))),e.append("<dl><dt>"+t.estateDesc.replace(t.markname,"<span>"+t.markname+"</span>")+"</dt><dd>"+t.address.replace(t.markname,"<span>"+t.markname+"</span>")+"</dd></dl>"),i.consts.$searchResultList.append(e)}),e&&e.length&&s&&$(".substitute-mask .list-container div").show(100),$(".substitute-mask .list li").off().click(function(t){var e=$(t.currentTarget);e.hasClass("no-data")||(i.setSearchCache(JSON.parse(decodeURIComponent(e.attr("data-detail")))),i.searchResultItemClick(JSON.parse(decodeURIComponent(e.attr("data-detail")))))})}},{key:"setSearchCache",value:function(t){var i=window.localStorage[this.moduleType+"SearchHistory"];i=i?JSON.parse(i):[];var e=[];$.each(i,function(i,a){if(a.value==t.value&&a.type==t.type||e.push(a),e.length>=4)return!1}),e.unshift(t),window.localStorage[this.moduleType+"SearchHistory"]=JSON.stringify(e)}},{key:"detectSearchResultClick",value:function(){var t=window.location.href.split("/"),i=ParamGenerator.queryString2Object(t[5]);if(i.hasOwnProperty("sli")||i.hasOwnProperty("sst")||i.hasOwnProperty("sdi")||i.hasOwnProperty("sto")||i.hasOwnProperty("sid")){var e=window.localStorage[this.moduleType+"SearchHistory"];e=e?JSON.parse(e):[],e.length&&$(".conning-tower dl dd span").text(e[0].estateDesc)}}}]),t}();
//# sourceMappingURL=conning-tower.min.js.map
